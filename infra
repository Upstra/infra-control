#!/bin/bash

# Script de gestion de l'infrastructure Infra Control
# Usage: ./infra [command]

set -e

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fichiers et r√©pertoires
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# D√©tection automatique de l'environnement
if [ -f ".env.rasp" ] && [ -f "/proc/device-tree/model" ] && grep -q "Raspberry Pi" "/proc/device-tree/model" 2>/dev/null; then
    ENV_FILE=".env.rasp"
    echo -e "${BLUE}üçì Raspberry Pi d√©tect√© - Utilisation de .env.rasp${NC}"
elif [ -f ".env.prod" ]; then
    ENV_FILE=".env.prod"
    echo -e "${BLUE}üöÄ Mode production - Utilisation de .env.prod${NC}"
else
    ENV_FILE=".env"
    echo -e "${YELLOW}‚ö†Ô∏è  Mode d√©veloppement - Utilisation de .env${NC}"
fi

COMPOSE_FILE="docker-compose.prod.yml"

# V√©rifier que le fichier .env existe
check_env() {
    if [ ! -f "$ENV_FILE" ]; then
        echo -e "${RED}‚ùå Fichier $ENV_FILE non trouv√©!${NC}"
        echo "Cr√©ez-le √† partir du template appropri√©"
        exit 1
    fi
}

# Afficher l'aide
show_help() {
    echo "Usage: ./infra [command]"
    echo ""
    echo "Commands:"
    echo "  deploy      - D√©ploiement complet avec restauration de backup"
    echo "  start       - D√©marre tous les services"
    echo "  stop        - Arr√™te tous les services"
    echo "  restart     - Red√©marre tous les services"
    echo "  status      - Affiche l'√©tat des services"
    echo "  logs        - Affiche les logs (suivis en temps r√©el)"
    echo "  backup      - Cr√©e une sauvegarde de la base de donn√©es"
    echo "  restore     - Restaure une sauvegarde"
    echo "  migrate     - Ex√©cute les migrations de base de donn√©es"
    echo "  clean       - Nettoie les conteneurs et volumes (ATTENTION: supprime les donn√©es)"
    echo "  help        - Affiche cette aide"
    echo ""
    echo "Examples:"
    echo "  ./infra deploy     # D√©ploiement initial"
    echo "  ./infra start      # D√©marrage normal"
    echo "  ./infra logs       # Voir les logs"
}

# D√©ploiement complet
deploy() {
    check_env
    echo -e "${BLUE}üöÄ D√©ploiement complet de l'infrastructure...${NC}"
    echo ""
    
    # √âtape 1: V√©rifier Docker
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}‚ùå Docker n'est pas install√©!${NC}"
        exit 1
    fi
    
    # √âtape 2: Cr√©er les dossiers n√©cessaires
    echo -e "${YELLOW}üìÅ Cr√©ation des dossiers...${NC}"
    mkdir -p backups logs
    
    # √âtape 3: Construire les images si n√©cessaire
    echo -e "${YELLOW}üî® Construction des images Docker...${NC}"
    docker-compose -f $COMPOSE_FILE --env-file $ENV_FILE build
    
    # √âtape 4: D√©marrer PostgreSQL et Redis
    echo -e "${YELLOW}üóÑÔ∏è  D√©marrage de PostgreSQL et Redis...${NC}"
    docker-compose -f $COMPOSE_FILE --env-file $ENV_FILE up -d postgres redis
    
    # Attendre que les services soient pr√™ts
    echo -e "${YELLOW}‚è≥ Attente du d√©marrage des services (15s)...${NC}"
    sleep 15
    
    # √âtape 5: Restaurer la backup si elle existe
    if ls backups/*.sql 1> /dev/null 2>&1; then
        echo -e "${YELLOW}üì• Restauration de la base de donn√©es...${NC}"
        LATEST_BACKUP=$(ls -t backups/*.sql | head -1)
        echo "   Utilisation de: $LATEST_BACKUP"
        
        docker exec -i infra-control-postgres psql -U postgres postgres < "$LATEST_BACKUP"
        
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}‚úÖ Base de donn√©es restaur√©e!${NC}"
        else
            echo -e "${RED}‚ùå Erreur lors de la restauration${NC}"
            echo -e "${YELLOW}   Continuons avec une base vierge...${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Aucune backup trouv√©e - D√©marrage avec base vierge${NC}"
    fi
    
    # √âtape 6: D√©marrer le backend
    echo -e "${YELLOW}üéØ D√©marrage du backend...${NC}"
    docker-compose -f $COMPOSE_FILE --env-file $ENV_FILE up -d backend
    
    # √âtape 7: D√©marrer les services de monitoring (optionnel)
    echo -e "${YELLOW}üìä D√©marrage des services de monitoring...${NC}"
    docker-compose -f $COMPOSE_FILE --env-file $ENV_FILE up -d prometheus grafana node-exporter || echo -e "${YELLOW}   Monitoring optionnel non d√©marr√©${NC}"
    
    # Attendre le d√©marrage complet
    echo -e "${YELLOW}‚è≥ Attente du d√©marrage complet (30s)...${NC}"
    sleep 30
    
    # V√©rifier l'√©tat
    echo -e "${BLUE}üîç V√©rification finale...${NC}"
    if curl -s http://localhost:8080/health/simple > /dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ Backend op√©rationnel!${NC}"
        
        # Afficher les URLs d'acc√®s
        if [ -f "/proc/device-tree/model" ] && grep -q "Raspberry Pi" "/proc/device-tree/model" 2>/dev/null; then
            IP=$(hostname -I | awk '{print $1}')
        else
            IP="localhost"
        fi
        
        echo ""
        echo -e "${GREEN}‚ú® D√©ploiement termin√© avec succ√®s!${NC}"
        echo ""
        echo -e "${BLUE}üìå Acc√®s aux services:${NC}"
        echo "   - API Backend: http://$IP:8080"
        echo "   - Documentation Swagger: http://$IP:8080/docs"
        echo "   - Prometheus: http://$IP:9090"
        echo "   - Grafana: http://$IP:3001 (admin/admin)"
    else
        echo -e "${RED}‚ùå Le backend ne r√©pond pas!${NC}"
        echo "   V√©rifiez les logs avec: ./infra logs backend"
        exit 1
    fi
}

# D√©marrer les services
start() {
    check_env
    echo -e "${BLUE}üöÄ D√©marrage de l'infrastructure...${NC}"
    
    docker-compose -f $COMPOSE_FILE --env-file $ENV_FILE up -d
    
    # Attendre un peu
    sleep 10
    
    # V√©rifier l'√©tat
    if curl -s http://localhost:8080/health/simple > /dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ Infrastructure d√©marr√©e${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Le backend met du temps √† d√©marrer...${NC}"
        echo "   V√©rifiez dans 30 secondes ou consultez les logs"
    fi
}

# Arr√™ter les services
stop() {
    echo -e "${YELLOW}üõë Arr√™t de l'infrastructure...${NC}"
    docker-compose -f $COMPOSE_FILE --env-file $ENV_FILE down
    echo -e "${GREEN}‚úÖ Infrastructure arr√™t√©e${NC}"
}

# Red√©marrer les services
restart() {
    echo -e "${YELLOW}üîÑ Red√©marrage de l'infrastructure...${NC}"
    docker-compose -f $COMPOSE_FILE --env-file $ENV_FILE restart
    echo -e "${GREEN}‚úÖ Infrastructure red√©marr√©e${NC}"
}

# Afficher l'√©tat des services
status() {
    echo -e "${BLUE}üìä √âtat des services:${NC}"
    docker-compose -f $COMPOSE_FILE --env-file $ENV_FILE ps
    
    echo -e "\n${BLUE}üîç Tests de sant√©:${NC}"
    
    # Backend
    if curl -s http://localhost:8080/health/simple > /dev/null 2>&1; then
        echo -e "  Backend: ${GREEN}‚úÖ OK${NC}"
    else
        echo -e "  Backend: ${RED}‚ùå KO${NC}"
    fi
    
    # PostgreSQL
    if docker exec infra-control-postgres pg_isready > /dev/null 2>&1; then
        echo -e "  PostgreSQL: ${GREEN}‚úÖ OK${NC}"
    else
        echo -e "  PostgreSQL: ${RED}‚ùå KO${NC}"
    fi
    
    # Redis
    if docker exec infra-control-redis redis-cli ping > /dev/null 2>&1; then
        echo -e "  Redis: ${GREEN}‚úÖ OK${NC}"
    else
        echo -e "  Redis: ${RED}‚ùå KO${NC}"
    fi
}

# Afficher les logs
logs() {
    SERVICE=$2
    if [ -z "$SERVICE" ]; then
        echo -e "${BLUE}üìú Logs de tous les services (Ctrl+C pour quitter):${NC}"
        docker-compose -f $COMPOSE_FILE --env-file $ENV_FILE logs -f --tail=100
    else
        echo -e "${BLUE}üìú Logs de $SERVICE (Ctrl+C pour quitter):${NC}"
        docker-compose -f $COMPOSE_FILE --env-file $ENV_FILE logs -f --tail=100 $SERVICE
    fi
}

# Cr√©er une sauvegarde
backup() {
    check_env
    echo -e "${BLUE}üíæ Cr√©ation d'une sauvegarde...${NC}"
    
    # Cr√©er le r√©pertoire de sauvegarde
    mkdir -p backups
    
    # Nom du fichier avec timestamp
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="backups/backup_${TIMESTAMP}.sql"
    
    # Effectuer la sauvegarde
    docker exec infra-control-postgres pg_dump -U postgres postgres > $BACKUP_FILE
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ Sauvegarde cr√©√©e: $BACKUP_FILE${NC}"
        ls -lh $BACKUP_FILE
    else
        echo -e "${RED}‚ùå Erreur lors de la sauvegarde${NC}"
        exit 1
    fi
}

# Restaurer une sauvegarde
restore() {
    check_env
    echo -e "${BLUE}üì• Restauration d'une sauvegarde...${NC}"
    
    # Lister les sauvegardes disponibles
    if [ ! -d "backups" ] || [ -z "$(ls -A backups/*.sql 2>/dev/null)" ]; then
        echo -e "${RED}‚ùå Aucune sauvegarde trouv√©e dans backups/${NC}"
        exit 1
    fi
    
    echo "Sauvegardes disponibles:"
    select BACKUP_FILE in backups/*.sql; do
        if [ -n "$BACKUP_FILE" ]; then
            break
        fi
    done
    
    echo -e "${YELLOW}‚ö†Ô∏è  ATTENTION: Cette op√©ration va √©craser la base actuelle!${NC}"
    read -p "Continuer? (oui/non): " confirm
    
    if [ "$confirm" != "oui" ]; then
        echo -e "${YELLOW}‚ùå Restauration annul√©e${NC}"
        exit 0
    fi
    
    # Restaurer
    docker exec -i infra-control-postgres psql -U postgres postgres < $BACKUP_FILE
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ Base restaur√©e depuis: $BACKUP_FILE${NC}"
    else
        echo -e "${RED}‚ùå Erreur lors de la restauration${NC}"
        exit 1
    fi
}

# Ex√©cuter les migrations
migrate() {
    echo -e "${BLUE}üîÑ Ex√©cution des migrations...${NC}"
    
    docker exec infra-control-backend pnpm migration:run
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ Migrations ex√©cut√©es${NC}"
    else
        echo -e "${RED}‚ùå Erreur lors des migrations${NC}"
        exit 1
    fi
}

# Nettoyer l'infrastructure
clean() {
    echo -e "${RED}‚ö†Ô∏è  ATTENTION: Suppression compl√®te des donn√©es!${NC}"
    read -p "√ätes-vous s√ªr? (oui/non): " confirm
    
    if [ "$confirm" != "oui" ]; then
        echo -e "${YELLOW}‚ùå Nettoyage annul√©${NC}"
        exit 0
    fi
    
    echo -e "${YELLOW}üßπ Nettoyage en cours...${NC}"
    docker-compose -f $COMPOSE_FILE --env-file $ENV_FILE down -v
    echo -e "${GREEN}‚úÖ Nettoyage termin√©${NC}"
}

# Commande principale
case "$1" in
    deploy)
        deploy
        ;;
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        restart
        ;;
    status)
        status
        ;;
    logs)
        logs $@
        ;;
    backup)
        backup
        ;;
    restore)
        restore
        ;;
    migrate)
        migrate
        ;;
    clean)
        clean
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}‚ùå Commande inconnue: $1${NC}"
        show_help
        exit 1
        ;;
esac